
# SG-for-Pods / AWS VPC CNI Diagnostics Toolkit (Linux)

This toolkit collects comprehensive diagnostics for AWS EKS pods using Security Groups for Pods (SGFP). It gathers **pod**, **node**, and **AWS ENI** data into a single bundle, optionally pulls **CloudTrail ENI API** activity (for throttles/errors), and generates a **markdown report** plus a **post-analyzer** summary.

## Features

- **Comprehensive Pod Diagnostics**: Collects pod annotations, conditions, network namespace routes/rules, and reachability tests
- **Security Group Validation**: Automatically validates actual SGs on pod ENI against expected SGs from pod, deployment, replicaset, or namespace annotations
- **SG Details**: Shows Security Group IDs, names, and descriptions for easy identification
- **Node Diagnostics**: Collects conntrack usage and aws-node logs
- **AWS ENI State**: Captures trunk and branch ENI information
- **API Diagnostics**: Analyzes CloudTrail events for ENI-related throttles and errors (with dry-run detection)
- **All-in-One Doctor Script**: Single command to collect, analyze, and report
- **Consistent Output Format**: Uses `[PREFIX]` format for clear, parseable output

## Requirements

- Linux
- `kubectl`, `jq`, `awk`, `grep`
- `aws` CLI configured (and `AWS_REGION` set, e.g., `export AWS_REGION=us-west-2`)
- Permissions: `ec2:DescribeNetworkInterfaces`, optionally CloudTrail `lookup-events`

## Quick Start

### Option 1: All-in-One (Recommended)

```bash
export AWS_REGION=us-west-2

# Run everything: collect, API diag, report, analyze, and display
./sgfp_doctor.sh <pod-name> -n default --minutes 60
```

### Option 2: Step-by-Step

```bash
export AWS_REGION=us-west-2

# 1) Collect a bundle for a pod (namespace default)
./sgfp_collect.sh -n default <pod-name>

# 2) (Optional) CloudTrail ENI API diagnostics for last 60 minutes
WINDOW_MINUTES=60 ./sgfp_api_diag.sh

# 3) Generate a report for the bundle
B=$(ls -dt sgfp_bundle_<pod-name>_* | head -1)
./sgfp_report.sh "$B"

# 4) Post analyze the bundle
./sgfp_post_analyze.sh "$B"
```

### Using Make Targets

```bash
# All-in-one
make doctor POD=<pod> NS=default

# Or step-by-step
make collect POD=<pod> NS=default
make api WINDOW_MINUTES=60
make report BUNDLE=<dir>
make analyze BUNDLE=<dir>

# Clean up all diagnostic output directories
make clean
```

## What gets collected

Bundle structure (example):

```
sgfp_bundle_<pod>_<timestamp>/
  pod_<pod>/
    pod_annotations.json
    pod_conditions.json
    pod_ip.txt
    node_name.txt
    pod_netns_routes_rules.txt
    pod_reachability.txt
    pod_branch_eni_id.txt
    pod_branch_eni_describe.json
    pod_branch_eni_sgs.txt              # Actual SGs on pod ENI
    pod_branch_eni_sgs_details.json     # SG IDs, names, descriptions
    pod_parent_trunk_eni.txt
    pod_expected_sgs.txt                 # Expected SGs from pod annotation
    deployment_expected_sgs.txt          # Expected SGs from deployment annotation
    replicaset_expected_sgs.txt          # Expected SGs from replicaset annotation
    namespace_expected_sgs.txt           # Expected SGs from namespace annotation
    deployment_annotations.json
    replicaset_annotations.json
    namespace_annotations.json
    aws_node_full.log
  node_<node>/
    node_conntrack_mtu.txt
    aws_node_full.log
  aws_<node>/
    vpc_id.txt
    node_instance_id.txt
    trunk_eni_id.txt
    trunk_eni.json
    all_instance_enis.json
    _all_branch_enis_in_vpc.json         # best-effort, may be empty
  report.md                              # generated by sgfp_report.sh
```

CloudTrail API diag folder:

```
sgfp_api_diag_<timestamp>/
  events_eni.json
  flat_events.json
  eni_errors.tsv                        # Real errors/throttles (excludes dry-runs)
  eni_dryruns.tsv                        # Dry-run operations (informational)
  eni_all_issues.tsv                     # All events with error codes
  error_codes_summary.txt                # Summary of all error codes
  throttle_by_action.txt
  throttle_by_caller.txt
  top_api_calls.txt
```

## Scripts

### `sgfp_doctor.sh` - All-in-One Orchestrator
Runs all diagnostics in sequence: collect → API diag → report → analyze → display report.

```bash
./sgfp_doctor.sh <pod> -n <namespace> [--minutes N] [--days D] [--region R] [--skip-api] [--api-dir DIR]
```

### `sgfp_collect.sh` - Collection Orchestrator
Collects pod, node, and AWS diagnostics into a bundle.

```bash
./sgfp_collect.sh -n <namespace> <pod-name>
```

**Features:**
- Automatically detects available shell in pod (`sh`, `/bin/sh`, `/bin/bash`, `bash`)
- Gracefully handles missing network tools (`ip`, `ping`)
- Collects Security Groups from pod ENI via AWS API
- Collects expected SGs from pod, deployment, replicaset, and namespace annotations
- Traverses Kubernetes owner references (Pod → ReplicaSet → Deployment)

### `sgfp_pod_diag.sh` - Pod Diagnostics
Collects pod-specific information including annotations, conditions, network namespace routes/rules.

### `sgfp_node_diag.sh` - Node Diagnostics
Collects node-level diagnostics: conntrack usage and aws-node logs.

### `sgfp_aws_diag.sh` - AWS ENI Diagnostics
Collects AWS ENI information: instance ID, VPC ID, trunk ENI, branch ENIs.

### `sgfp_api_diag.sh` - CloudTrail API Diagnostics
Analyzes CloudTrail events for ENI-related API calls, throttles, and errors.

```bash
WINDOW_MINUTES=60 ./sgfp_api_diag.sh
```

**Features:**
- Distinguishes real errors/throttles from dry-run operations
- Categorizes events: `eni_errors.tsv` (real issues), `eni_dryruns.tsv` (informational)
- Provides summaries by action, caller, and error codes

### `sgfp_report.sh` - Report Generator
Generates a markdown report from the collected bundle.

**Features:**
- Shows Security Group IDs, names, and descriptions
- Validates actual SGs against expected SGs (from annotations)
- Uses consistent `[OK]`, `[ISSUE]`, `[INFO]` format

### `sgfp_post_analyze.sh` - Quick Analysis
Provides a quick summary of potential issues found in the bundle.

**Features:**
- Validates Security Groups (actual vs expected)
- Checks pod status, readiness gates, routing tables
- Uses consistent `[OK]`, `[ISSUE]`, `[INFO]` format

## Security Group Validation

The toolkit automatically validates Security Groups by:

1. **Collecting actual SGs** from the pod's ENI via AWS API
2. **Collecting expected SGs** from Kubernetes annotations (in priority order):
   - Pod annotation: `vpc.amazonaws.com/security-groups`
   - Deployment annotation: `vpc.amazonaws.com/security-groups`
   - ReplicaSet annotation: `vpc.amazonaws.com/security-groups`
   - Namespace annotation: `vpc.amazonaws.com/security-groups`
3. **Comparing** actual vs expected and reporting mismatches

The report shows:
- Actual SGs with names and descriptions
- Expected SGs (if specified)
- Validation status: Match, Mismatch, or No expected SGs specified

## Output Format

All scripts use a consistent `[PREFIX]` output format:
- `[OK]` - Successful check
- `[ISSUE]` - Problem detected
- `[INFO]` - Informational message
- `[WARN]` - Warning
- `[ERROR]` - Error condition

Script-specific prefixes:
- `[DOCTOR]` - Doctor script
- `[NODE]` - Node diagnostics
- `[AWS]` - AWS diagnostics
- `[API]` - API diagnostics
- `[ANALYZE]` - Post-analyze script
- `[REPORT]` - Report generator

## Make Targets

```bash
make collect POD=<pod> NS=default      # Collect diagnostics
make api WINDOW_MINUTES=60             # API diagnostics
make report BUNDLE=<dir>               # Generate report
make analyze BUNDLE=<dir>              # Post-analyze
make doctor POD=<pod> NS=default       # All-in-one
make clean                             # Remove all diagnostic output directories
```

## Notes

- The collectors are **best-effort**. Missing permissions or components are handled gracefully; files still get created (possibly empty) so later steps won't crash.
- **Shell Detection**: Scripts automatically detect available shells in pods (`sh`, `/bin/sh`, `/bin/bash`, `bash`) for better compatibility.
- **Network Tools**: Missing network tools (`ip`, `ping`) in pods are handled gracefully with informative messages.
- **ICMP Reachability**: ICMP may be blocked; `pod_reachability.txt` is informational only.
- **Security Groups**: SG names and descriptions require `ec2:DescribeSecurityGroups` permission. The toolkit automatically fetches this information when available.
- **Dry-Run Operations**: API diagnostics distinguish between real errors/throttles and successful dry-run validations.
- **Output Directories**: All diagnostic output directories (`sgfp_bundle_*`, `sgfp_diag_*`, `sgfp_api_diag_*`) are automatically ignored by git (see `.gitignore`).

## Requirements

- Linux
- `kubectl`, `jq`, `awk`, `grep`
- `aws` CLI configured (and `AWS_REGION` set, e.g., `export AWS_REGION=us-west-2`)
- Permissions:
  - `ec2:DescribeNetworkInterfaces` (required)
  - `ec2:DescribeSecurityGroups` (for SG names/descriptions)
  - CloudTrail `lookup-events` (optional, for API diagnostics)
