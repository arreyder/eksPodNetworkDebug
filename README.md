
# SG-for-Pods / AWS VPC CNI Diagnostics Toolkit (Linux)

This bundle collects **pod**, **node**, and **AWS ENI** data into a single bundle, optionally pulls **CloudTrail ENI API** activity (for throttles), and generates a **markdown report** plus a **post-analyzer** summary.

## Requirements

- Linux
- `kubectl`, `jq`, `awk`, `grep`
- `aws` CLI configured (and `AWS_REGION` set, e.g., `export AWS_REGION=us-west-2`)
- Permissions: `ec2:DescribeNetworkInterfaces`, optionally CloudTrail `lookup-events`

## Quick Start

```bash
export AWS_REGION=us-west-2

# 1) Collect a bundle for a pod (namespace default)
./sgfp_collect.sh -n default <pod-name>

# 2) (Optional) CloudTrail ENI API diagnostics for last 2 days
WINDOW_MINUTES=2880 ./sgfp_api_diag.sh

# 3) Generate a report for the bundle
B=$(ls -dt sgfp_bundle_<pod-name>_* | head -1)
./sgfp_report.sh "$B"

# 4) Post analyze the bundle
./sgfp_post_analyze.sh "$B"
```

## What gets collected

Bundle structure (example):

```
sgfp_bundle_<pod>_<timestamp>/
  pod_<pod>/
    pod_annotations.json
    pod_conditions.json
    pod_ip.txt
    node_name.txt
    pod_netns_routes_rules.txt
    pod_reachability.txt
    pod_branch_eni_id.txt
    pod_branch_eni_describe.json
    pod_branch_eni_sgs.txt
    pod_parent_trunk_eni.txt
    ipamd_introspection.json
    aws_node_full.log
  node_<node>/
    node_conntrack_mtu.txt
    aws_node_full.log
  aws_<node>/
    vpc_id.txt
    node_instance_id.txt
    trunk_eni_id.txt
    trunk_eni.json
    all_instance_enis.json
    _all_branch_enis_in_vpc.json   # best-effort, may be empty
report.md                          # generated by sgfp_report.sh
```

CloudTrail API diag folder:

```
sgfp_api_diag_<timestamp>/
  events_eni.json
  flat_events.json
  eni_errors.tsv
  throttle_by_action.txt
  throttle_by_caller.txt
  top_api_calls.txt
```

## Make targets (optional)

```bash
make collect POD=<pod> NS=default
make api WINDOW_MINUTES=1440
make report BUNDLE=<dir>
make analyze BUNDLE=<dir>
```

---

## Notes

- The collectors are **best-effort**. Missing permissions or components are handled gracefully; files still get created (possibly empty) so later steps won't crash.
- ICMP may be blocked; `pod_reachability.txt` is informational only.
- SG names (not just IDs) require `ec2:DescribeSecurityGroups` â€” you can extend `sgfp_report.sh` if you want that resolution.
